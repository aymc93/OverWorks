<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>OverWorks ‚Äî Rooms, Lobby & Unity</title>
<style>
:root{
  --bg: linear-gradient(135deg,#8d0bad,#FDC500);
  --card:#1b1c2456;
  --muted:#a8b0c0;
  --text:#F72585;
  --accent:#FF6B6B;
  --ok:#2ed573; --warn:#ffa502;
  --button-bg:#4c0dab; --button-hover:#6a0dad; --button-text:#fff;
}
*{box-sizing:border-box}
html,body{margin:0;height:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--text)}
.wrap{max-width:1200px;margin:0 auto;padding:32px}
h1{margin:0 0 24px;text-align:center;font-size:32px}
.badge{display:inline-flex;align-items:center;gap:8px;background:var(--accent);color:#fff;border-radius:999px;padding:6px 12px;font-size:13px}
.main{display:flex;gap:32px;flex-wrap:wrap;justify-content:center}
.left,.right{display:flex;flex-direction:column;gap:32px}
.left{flex:2 1 620px}
.right{flex:1 1 360px}
.card{background:var(--card);border:1px solid #2a2c33;border-radius:24px;padding:24px;box-shadow:0 12px 30px rgba(0,0,0,.35)}
.grid{display:grid;gap:16px}
.two{grid-template-columns:repeat(2,1fr)}
.row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
.stack{display:flex;flex-direction:column;gap:8px}
input,button{border-radius:14px;font-size:16px;padding:12px 14px}
input{width:100%;border:2px solid #ddd;background:#fff;color:#111}
button{cursor:pointer;background:var(--button-bg);color:var(--button-text);border:none;font-weight:700;box-shadow:0 10px 24px rgba(0,0,0,.3);transition:transform .1s,background .2s}
button:hover{background:var(--button-hover);transform:translateY(1px)}
button.primary{background:var(--accent)}
button.ghost{background:transparent;border:2px solid #fff}
.small{font-size:12px;color:var(--muted)}
.center{display:flex;align-items:center;justify-content:center}
#players{max-height:340px;overflow:auto;display:grid;gap:10px}
.player{display:flex;justify-content:space-between;align-items:center;background:#101219;border:1px solid #22252e;border-radius:14px;padding:10px 12px}
.player.me{outline:2px solid var(--warn)}
.footer{margin-top:40px;text-align:center;opacity:.85}
section[hidden]{display:none !important}

/* === Stage / Unity container === */
#stage{height:480px;border-radius:22px;background:#0e1015;position:relative;overflow:hidden;display:flex;align-items:center;justify-content:center;color:#fff;border:2px solid #23252c}
#unity-canvas{width:100%;height:100%;display:block;background:#000;border-radius:20px}

/* === Loader Unity === */
#unityLoader{position:absolute;inset:0;background:#0e1015;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:10;color:#fff;font-size:18px}
#unityLoader .bar{width:60%;height:18px;background:#222;border-radius:10px;overflow:hidden;margin-top:12px;box-shadow:inset 0 0 0 1px rgba(255,255,255,.06)}
#unityLoader .bar-fill{height:100%;width:0;background:var(--accent);transition:width .25s}
#unityLoader .tip{margin-top:12px;opacity:.8;font-size:12px}

/* === Countdown 3-2-1-GO === */
#countdown{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;z-index:20;pointer-events:none}
#countdown span{font-size:140px;font-weight:900;color:#fff;text-shadow:0 10px 40px rgba(0,0,0,.9), 0 0 12px rgba(255,255,255,.15);opacity:0;transform:scale(.6) rotate(-2deg);animation:pop 1s forwards}
#countdown.go span{color:var(--ok)}
@keyframes pop{
  0%{opacity:0;transform:scale(.6) rotate(-6deg)}
  25%{opacity:1;transform:scale(1.2) rotate(2deg)}
  55%{opacity:1;transform:scale(1) rotate(0)}
  100%{opacity:0;transform:scale(.8) rotate(0)}
}
</style>
</head>
<body>
<div class="wrap">
  <h1>üéâ OverWorks | <span id="titlePhase">Connexion</span> <span class="badge" id="roomBadge">room: ‚Äî</span></h1>

  <!-- ===== 1) Connexion ===== -->
  <section id="screen-login">
    <div class="main">
      <div class="right" style="flex:1 1 560px;max-width:640px">
        <div class="card grid">
          <div class="grid two">
            <div class="stack">
              <label for="name">Pseudo</label>
              <input id="name" placeholder="ex: T1 Bruninio" autocomplete="nickname" />
            </div>
            <div class="stack">
              <label for="room">Code salle</label>
              <input id="room" placeholder="ex: CAFE" maxlength="8" autocapitalize="characters" />
            </div>
          </div>
          <div class="row" style="justify-content:flex-end">
            <button id="create" class="primary">Cr√©er une salle</button>
            <button id="join" class="ghost">Rejoindre</button>
            <button id="copyLink" class="ghost" title="Copier le lien d‚Äôinvite">üîó Partager</button>
          </div>
          <div class="small">Astuce : partage un lien <code>?room=CAFE</code> pour pr√©-remplir le code.</div>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== 2) Lobby ===== -->
  <section id="screen-lobby" hidden>
    <div class="main">
      <div class="left">
        <div class="card">
          <div class="row" style="justify-content:space-between">
            <strong>Joueurs</strong>
            <span class="small" id="hostHint">H√¥te : ‚Äî</span>
          </div>
          <div id="players"></div>
        </div>
      </div>
      <div class="right">
        <div class="card stack">
          <strong>Contr√¥les</strong>
          <div class="row">
            <button id="start" class="primary" disabled>‚ñ∂Ô∏è Lancer la partie</button>
            <button id="leave" class="ghost">Quitter la salle</button>
          </div>
          <div class="small">Seul l‚Äôh√¥te peut lancer. Si l‚Äôh√¥te part, un autre devient h√¥te.</div>
        </div>
        <div class="card stack">
          <strong>Comment √ßa marche</strong>
          <ol class="small">
            <li>Cr√©e/Rejoins une salle et invite tes amis.</li>
            <li>Quand tout le monde est pr√™t, l‚Äôh√¥te lance.</li>
            <li>L‚Äô√©cran Jeu charge le build Unity (WebGL).</li>
          </ol>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== 3) Jeu (Unity) ===== -->
  <section id="screen-game" hidden>
    <div class="main">
      <div class="left">
        <div class="card">
          <div id="stage">
            <!-- Canvas Unity -->
            <canvas id="unity-canvas" tabindex="0"></canvas>
            <!-- Loader Unity (overlay) -->
            <div id="unityLoader" hidden>
              <div>Chargement du jeu‚Ä¶</div>
              <div class="bar"><div class="bar-fill" id="loaderFill"></div></div>
              <div class="tip">Astuce : utilise <span style="opacity:.9">Ctrl/Cmd + Minus</span> pour zoom arri√®re si l‚Äô√©cran est trop grand.</div>
            </div>
            <!-- Countdown (overlay) -->
            <div id="countdown"></div>
          </div>
          <div id="statusBar">
            <div>Manche <span id="round">1</span> ‚Ä¢ <span id="phase">pr√©paration</span></div>
            <div>‚è≥ <span id="timer">‚Äî</span>s</div>
          </div>
        </div>
      </div>
      <div class="right">
        <div class="card stack">
          <strong>Contr√¥les</strong>
          <div class="row">
            <button id="backToLobby" class="ghost">‚üµ Retour lobby</button>
          </div>
          <div class="small">L‚Äôoverlay ‚Äú3-2-1-GO‚Äù s‚Äôaffiche au d√©marrage de la manche.</div>
        </div>
      </div>
    </div>
  </section>

  <div class="footer small">OverWorks ‚Ä¢ Realtime Database uniquement ‚Ä¢ Pas de donn√©es perso</div>
</div>

<script type="module">
/* ========= Firebase ========= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
import {
  getDatabase, ref, get, set, update, remove, onValue,
  serverTimestamp, onDisconnect, child
} from "https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js";

/* ---- Config (remplace) ---- */
const firebaseConfig = {
  apiKey: "AIzaSyCkYbtXdu4SEFAIVUn0XAbxqZr1dqxk5PA",
  authDomain: "overworks-33a39.firebaseapp.com",
  databaseURL: "https://overworks-33a39-default-rtdb.europe-west1.firebasedatabase.app", // ex: https://ton-projet-default-rtdb.europe-west1.firebasedatabase.app
  projectId: "overworks-33a39",
  storageBucket: "overworks-33a39.firebasestorage.app",
  messagingSenderId: "914912775709",
  appId: "1:914912775709:web:ce6218d6490fd88fa4c0f4"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

/* ========= UNITY (param) =========
   Mets ici le chemin de ton build WebGL Unity (template r√©cent).
   Exemple si tu as export√© dans /UnityBuild/Build/* :
   const UNITY_BUILD_PATH = "./UnityBuild/Build";
   Le script loader s‚Äôappelle souvent:  <nom>.loader.js
*/
const UNITY_BUILD_PATH = "./UnityBuild/Build"; // üîß √Ä ADAPTER
const UNITY_PRODUCT_NAME = "Build";            // nom de base g√©n√©r√© par Unity (souvent "Build")
let unityInstance = null;
let unityLoaded = false;

/* ========= SPA screens ========= */
const scrLogin = document.getElementById('screen-login');
const scrLobby = document.getElementById('screen-lobby');
const scrGame  = document.getElementById('screen-game');
function showScreen(id){
  scrLogin.hidden = id!=='screen-login';
  scrLobby.hidden = id!=='screen-lobby';
  scrGame.hidden  = id!=='screen-game';
  document.getElementById('titlePhase').textContent =
    id==='screen-login' ? 'Connexion' : id==='screen-lobby' ? 'Lobby' : 'Jeu';
}

/* ========= DOM ========= */
const nameEl = document.getElementById('name');
const roomEl = document.getElementById('room');
const createBtn = document.getElementById('create');
const joinBtn   = document.getElementById('join');
const copyBtn   = document.getElementById('copyLink');
const startBtn  = document.getElementById('start');
const leaveBtn  = document.getElementById('leave');
const backBtn   = document.getElementById('backToLobby');
const roomBadge = document.getElementById('roomBadge');
const playersEl = document.getElementById('players');
const hostHint  = document.getElementById('hostHint');

const stageEl   = document.getElementById('stage');
const loaderEl  = document.getElementById('unityLoader');
const loaderFill= document.getElementById('loaderFill');
const canvasEl  = document.getElementById('unity-canvas');
const countdownEl = document.getElementById('countdown');

/* ========= State ========= */
let uid = null;
let currentRoom = null;
let unsubPlayers = null;
let unsubRoomMeta = null;

/* ========= Helpers ========= */
const CODE_CHARS = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
function genCode(n=4){ let s=''; for(let i=0;i<n;i++) s+=CODE_CHARS[Math.floor(Math.random()*CODE_CHARS.length)]; return s; }
function normalizeCode(s){ return (s||'').trim().toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,8); }
function playerItem({name, score, isHost}, isMe){
  const div = document.createElement('div');
  div.className = 'player' + (isMe ? ' me' : '');
  div.innerHTML = `<span>${name} ${isHost?'üëë':''}</span><strong>${score ?? 0}</strong>`;
  return div;
}

/* ========= Auth ========= */
signInAnonymously(auth).catch(console.error);
onAuthStateChanged(auth, user=>{
  if(!user) return;
  uid = user.uid;
  // Prefill depuis ?room=X
  const params = new URLSearchParams(location.search);
  const preRoom = params.get('room');
  if(preRoom){ roomEl.value = preRoom; }
  showScreen('screen-login');
});

/* ========= Presence cleanup ========= */
function attachPresence(roomCode){
  const pRef = ref(db, `rooms/${roomCode}/players/${uid}`);
  onDisconnect(pRef).remove();
}

/* ========= Host (r√©)√©lection ========= */
async function electHostIfNeeded(roomCode){
  const metaRef = ref(db, `rooms/${roomCode}`);
  const snap = await get(metaRef);
  if(!snap.exists()) return;
  const room = snap.val();
  const playersSnap = await get(child(metaRef,'players'));
  const players = playersSnap.exists()? playersSnap.val() : {};
  if(room.hostUid && players[room.hostUid]) return;

  const uids = Object.keys(players);
  if(uids.length===0){ await remove(metaRef).catch(()=>{}); return; }
  const sorted = uids.sort((a,b)=>{
    const ja = players[a].joinedAt || 0, jb = players[b].joinedAt || 0;
    return ja===jb ? a.localeCompare(b) : ja - jb;
  });
  const newHost = sorted[0];
  const updates = {};
  updates[`rooms/${roomCode}/hostUid`] = newHost;
  for(const id of uids){ updates[`rooms/${roomCode}/players/${id}/isHost`] = (id===newHost); }
  await update(ref(db), updates).catch(()=>{});
}

/* ========= UI bindings ========= */
createBtn.addEventListener('click', async ()=>{
  const name = (nameEl.value||'Joueur').trim().slice(0,18);
  let code = normalizeCode(roomEl.value);
  if(code.length<4) code = genCode(4);

  // √©vite collision simple
  let tries=0;
  while(tries<5){
    const exists = (await get(ref(db, `rooms/${code}`))).exists();
    if(!exists) break;
    code = genCode(4); tries++;
  }

  const roomRef = ref(db, `rooms/${code}`);
  const now = Date.now();
  await set(roomRef, { createdAt: serverTimestamp(), started: false, hostUid: uid, code });
  await set(child(roomRef, `players/${uid}`), { name, score: 0, isHost: true, joinedAt: now });

  currentRoom = code;
  roomBadge.textContent = `room: ${code}`;
  history.replaceState(null,'',`?room=${code}`);
  attachPresence(code);
  subscribeRoom(code);
  showScreen('screen-lobby');
});

joinBtn.addEventListener('click', async ()=>{
  const code = normalizeCode(roomEl.value);
  if(code.length<4){ alert('Entre un code salle valide (‚â• 4 car.)'); return; }

  const roomRef = ref(db, `rooms/${code}`);
  const snap = await get(roomRef);
  if(!snap.exists()){ alert('Salle introuvable'); return; }

  const name = (nameEl.value||'Joueur').trim().slice(0,18);
  const now = Date.now();
  await set(child(roomRef, `players/${uid}`), { name, score: 0, isHost: false, joinedAt: now });

  currentRoom = code;
  roomBadge.textContent = `room: ${code}`;
  history.replaceState(null,'',`?room=${code}`);
  attachPresence(code);
  subscribeRoom(code);
  await electHostIfNeeded(code);
  showScreen('screen-lobby');
});

copyBtn.addEventListener('click', async ()=>{
  let code = currentRoom || normalizeCode(roomEl.value);
  if(!code){ alert("Cr√©e ou entre une salle d'abord."); return; }
  const url = `${location.origin}${location.pathname}?room=${code}`;
  await navigator.clipboard.writeText(url).catch(()=>{});
  copyBtn.textContent = 'Lien copi√© ‚úÖ';
  setTimeout(()=>copyBtn.textContent='üîó Partager',1200);
});

startBtn.addEventListener('click', async ()=>{
  if(!currentRoom) return;
  const metaRef = ref(db, `rooms/${currentRoom}`);
  const meta = (await get(metaRef)).val() || {};
  if(meta.hostUid !== uid){ alert("Seul l'h√¥te peut lancer."); return; }
  // d√©marre la partie (tout le monde √©coute "started")
  await update(metaRef, { started: true });
});

leaveBtn.addEventListener('click', async ()=>{
  if(!currentRoom) return;
  try{
    await remove(ref(db, `rooms/${currentRoom}/players/${uid}`));
    await electHostIfNeeded(currentRoom);
  }finally{
    currentRoom = null;
    roomBadge.textContent = 'room: ‚Äî';
    if(unsubPlayers) unsubPlayers(); if(unsubRoomMeta) unsubRoomMeta();
    showScreen('screen-login');
  }
});

backBtn.addEventListener('click', ()=>{
  showScreen('screen-lobby');
});

/* ========= Subscriptions ========= */
function subscribeRoom(code){
  if(unsubPlayers) unsubPlayers();
  if(unsubRoomMeta) unsubRoomMeta();

  const roomRef = ref(db, `rooms/${code}`);
  const playersRef = child(roomRef,'players');

  unsubPlayers = onValue(playersRef, async (snap)=>{
    playersEl.innerHTML = '';
    const players = snap.val() || {};
    const list = Object.entries(players).sort((a,b)=>{
      const ja=a[1].joinedAt||0, jb=b[1].joinedAt||0;
      return ja===jb ? a[0].localeCompare(b[0]) : ja-jb;
    });
    for(const [pid, p] of list){ playersEl.appendChild(playerItem(p, pid===uid)); }
    await electHostIfNeeded(code);
  });

  unsubRoomMeta = onValue(roomRef, (snap)=>{
    const data = snap.val() || {};
    const isHost = data.hostUid === uid;
    startBtn.disabled = !isHost;
    hostHint.textContent = `H√¥te : ${data.hostUid ? 'üëë dans la liste' : '‚Äî'}`;
    roomBadge.textContent = `room: ${data.code || code}`;

    // Quand l‚Äôh√¥te lance ‚Üí tout le monde passe en √©cran jeu + charge Unity + countdown
    if(data.started){
      showScreen('screen-game');
      startUnityIfNeeded().then(()=>{
        startCountdown(); // lance 3-2-1-GO (apr√®s chargement Unity)
      });
    }
  });

  // Nettoyage si onglet ferm√©
  window.onbeforeunload = async ()=>{
    if(!currentRoom) return;
    try{ await remove(ref(db, `rooms/${currentRoom}/players/${uid}`)); }catch{}
  };
}

/* ========= Unity loader (createUnityInstance) =========
   Charge dynamiquement le loader de Unity et instancie le build.
   - Montre la barre de progression via onProgress.
   - Cache le loader quand c‚Äôest pr√™t.
*/
async function startUnityIfNeeded(){
  if(unityLoaded) return unityInstance;
  // Affiche loader visuel
  showUnityLoader(true); setUnityProgress(0);

  // Charge le script loader Unity (Build.loader.js)
  const loaderSrc = `${UNITY_BUILD_PATH}/${UNITY_PRODUCT_NAME}.loader.js`;
  await loadScript(loaderSrc);

  // createUnityInstance est inject√© par le loader
  if(typeof createUnityInstance !== "function"){
    console.error("createUnityInstance non trouv√©. V√©rifie UNITY_BUILD_PATH / PRODUCT_NAME.");
    showUnityLoader(false);
    return null;
  }

  const buildUrl = UNITY_BUILD_PATH;
  const config = {
    dataUrl: `${buildUrl}/${UNITY_PRODUCT_NAME}.data`,
    frameworkUrl: `${buildUrl}/${UNITY_PRODUCT_NAME}.framework.js`,
    codeUrl: `${buildUrl}/${UNITY_PRODUCT_NAME}.wasm`,
    streamingAssetsUrl: "StreamingAssets",
    companyName: "OverWorks",
    productName: "OverWorks",
    productVersion: "1.0"
  };

  try{
    unityInstance = await createUnityInstance(canvasEl, config, (progress)=>{
      setUnityProgress(Math.floor(progress*100));
    });
    unityLoaded = true;
    showUnityLoader(false);
    return unityInstance;
  }catch(e){
    console.error(e);
    showUnityLoader(false);
    alert("Erreur de chargement Unity. V√©rifie le chemin du build.");
    return null;
  }
}

function loadScript(src){
  return new Promise((resolve,reject)=>{
    const s=document.createElement('script');
    s.src=src; s.async=true;
    s.onload=()=>resolve();
    s.onerror=()=>reject(new Error('load '+src));
    document.head.appendChild(s);
  });
}

function showUnityLoader(v){
  loaderEl.hidden = !v;
  if(v) setUnityProgress(0);
}
function setUnityProgress(pct){
  loaderFill.style.width = (pct||0) + "%";
}

/* ========= Countdown anim√© 3-2-1-GO ========= */
function startCountdown(){
  const seq = ["3","2","1","GO"];
  let i=0;
  countdownEl.innerHTML="";

  function step(){
    if(i>=seq.length){ countdownEl.innerHTML=""; return; }
    const span=document.createElement("span");
    span.textContent = seq[i];
    if(seq[i]==="GO") countdownEl.classList.add("go"); else countdownEl.classList.remove("go");
    countdownEl.innerHTML=""; countdownEl.appendChild(span);
    i++; setTimeout(step, 900); // rythme punchy ~0.9s
  }
  step();
}
</script>
</body>
</html>
